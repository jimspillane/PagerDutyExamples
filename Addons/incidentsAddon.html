<!DOCTYPE html>
<html>

<head>
    <style>
        .axis path,
        .axis line {
            fill: none;
            stroke: #eee;
            shape-rendering: crispEdges;
        }
        
        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }
        
        .loading {
            font-family: sans-serif;
            font-size: 15px;
        }
        
        .circle {
            fill: #222;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.14/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js"></script>
</head>

<body>
    <div>
        <h1>PagerDuty Users CSV</h1>
    </div>
    <div>
        <div id="punchcard"></div>
    </div>
    <script>
        function getParameterByName(name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        // Handle onlclick and get Users 
        function getData(apikey, subdomain) {

            var pdURL = "https://" + subdomain + ".pagerduty.com/api/v1/reports/raw/incidents.csv?" +
                "since=" + moment().startOf('day').add(-141, 'days').format() + "&" +
                "until=" + moment().startOf('day').add(-1, 'days').format() + "&filters%5Burgency%5D=high%2Clow";

            var settings = {
                "url": pdURL,
                "method": "GET",
                "headers": {
                    "accept": "application/vnd.pagerduty+json;version=1.1",
                    "content-type": "application/json",
                    "Authorization": "Token token=" + apikey
                }
            };

            // Get the Users with jQuery
            // Parse the reponse to CSV using Papa Parse(http://papaparse.com/)
            // put the result in the text area
            $.ajax(settings).done(function(response) {
                createChart(Papa.parse(response, {
                    header: true
                }));
            });
        }

        function createChart(data) {
            console.log(data);
            
            var w = 940,
                h = 300,
                pad = 20,
                left_pad = 100,
                Data_url = '/data.json';

            var svg = d3.select("#punchcard")
                .append("svg")
                .attr("width", w)
                .attr("height", h);

            var x = d3.scale.linear().domain([0, 23]).range([left_pad, w - pad]),
                y = d3.scale.linear().domain([0, 6]).range([pad, h - pad * 2]);

            var xAxis = d3.svg.axis().scale(x).orient("bottom")
                .ticks(24)
                .tickFormat(function(d, i) {
                    var m = (d & gt; 12) ? "p" : "a";
                    return (d % 12 == 0) ? 12 + m : d % 12 + m;
                }),
                yAxis = d3.svg.axis().scale(y).orient("left")
                .ticks(7)
                .tickFormat(function(d, i) {
                    return ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][d];
                });

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0, " + (h - pad) + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + (left_pad - pad) + ", 0)")
                .call(yAxis);

            svg.append("text")
                .attr("class", "loading")
                .text("Loading ...")
                .attr("x", function() {
                    return w / 2;
                })
                .attr("y", function() {
                    return h / 2 - 5;
                });

            d3.json(Data_url, function(punchcard_data) {
                var max_r = d3.max(punchcard_data.map(
                        function(d) {
                            return d[2];
                        })),
                    r = d3.scale.linear()
                    .domain([0, d3.max(punchcard_data, function(d) {
                        return d[2];
                    })])
                    .range([0, 12]);

                svg.selectAll(".loading").remove();

                svg.selectAll("circle")
                    .data(punchcard_data)
                    .enter()
                    .append("circle")
                    .attr("class", "circle")
                    .attr("cx", function(d) {
                        return x(d[1]);
                    })
                    .attr("cy", function(d) {
                        return y(d[0]);
                    })
                    .transition()
                    .duration(800)
                    .attr("r", function(d) {
                        return r(d[2]);
                    });
            });


        }

        getData(getParameterByName('apikey'), getParameterByName('subdomain'));
    </script>
</body>

</html>